<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <link rel="dns-prefetch" href="http://yoursite.com">
  
  <title>python第六章_Socket | sgupergitquery</title>
  <meta name="author" content="sgupergitquery">
  
  <meta name="description" content="notes">
  
  
  <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">

  <meta property="og:title" content="python第六章_Socket"/>
  <meta property="og:site_name" content="sgupergitquery"/>

  
    <meta property="og:image" content=""/>
  

  <link rel="alternate" href="/atom.xml" title="sgupergitquery" type="application/atom+xml">

  <link rel="preload" as="style" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">

  <link rel="icon" class="js-site-favicon" type="image/svg+xml" href="https://github.githubassets.com/favicons/favicon.svg">
  <link href="https://unpkg.com" rel="dns-prefetch" />
  <link href="https://busuanzi.ibruce.info" rel="dns-prefetch" />
  <link href="https://cdn1.lncld.net" rel="dns-prefetch" />
  
  <link href="https://xpjzs0ff.api.lncld.net" rel="dns-prefetch" />
  
<meta name="generator" content="Hexo 4.2.1"></head>

<body>
  <div class="container">


    <div class="left-col" style="background-image:url('https://tva1.sinaimg.cn/large/007S8ZIlgy1ggdmi6yapmj30dw0zk0wm.jpg')">
      <div class="intrude-less">
        <header id="header" class="inner">
          <a href="/">
            <div class="profilepic"><img src='https://s1.ax1x.com/2020/07/08/UZrhJx.jpg'></div>
          </a>
          <div class="author-name"><a href="/">sgupergitquery</a></div>
          <p class="aboutme">notes</p>
          <nav id="main-nav">
            <ul class="main">
              
              <li>
                
                  <a href="/archives">归档</a>
                
              </li>
              
              <li>
                
                  <a href="/categories">专题</a>
                
              </li>
              
            </ul>
          </nav>
          <nav id="sub-nav">
            <div class="social">
              
              
              
              
              
              
            </div>
          </nav>
        </header>
      </div>

    </div>



    <div class="mid-col">
      <div class="mid-col-container">
        <div id="content" class="inner">
          <article class="post">

  
    <div class="meta">
      
<div class="date">

<time datetime="2020-07-29T16:00:00.000Z"
      
      data-updated="true"
       itemprop="datePublished">
  2020-07-30
</time>





</div>

    </div>
  
  <h1 class="title" itemprop="name">python第六章_Socket</h1>
  <div class="entry-content" itemprop="articleBody">
    
    <div class="post-toc" id='TOC'>
      <div class="toc-title">TOC</div>
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Socket"><span class="toc-number">1.</span> <span class="toc-text">Socket</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Socket套接字方法"><span class="toc-number">2.</span> <span class="toc-text">Socket套接字方法</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#服务端套接字函数"><span class="toc-number">2.1.</span> <span class="toc-text">服务端套接字函数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#客户端套接字函数"><span class="toc-number">2.2.</span> <span class="toc-text">客户端套接字函数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#公共用途的套接字函数"><span class="toc-number">2.3.</span> <span class="toc-text">公共用途的套接字函数</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#TCP代码实例"><span class="toc-number">3.</span> <span class="toc-text">TCP代码实例</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#循环收发数据"><span class="toc-number">3.1.</span> <span class="toc-text">循环收发数据</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#一问一回聊天"><span class="toc-number">3.2.</span> <span class="toc-text">一问一回聊天</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#连接循环"><span class="toc-number">3.3.</span> <span class="toc-text">连接循环</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#模拟ssh远程执行命令"><span class="toc-number">3.4.</span> <span class="toc-text">模拟ssh远程执行命令</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#粘包"><span class="toc-number">4.</span> <span class="toc-text">粘包</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#客户端粘包"><span class="toc-number">4.1.</span> <span class="toc-text">客户端粘包</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#服务端粘包"><span class="toc-number">4.2.</span> <span class="toc-text">服务端粘包</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#总结"><span class="toc-number">4.3.</span> <span class="toc-text">总结</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#粘包解决方案"><span class="toc-number">5.</span> <span class="toc-text">粘包解决方案</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#粗略版"><span class="toc-number">5.1.</span> <span class="toc-text">粗略版</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#普通版"><span class="toc-number">5.2.</span> <span class="toc-text">普通版</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#进阶版"><span class="toc-number">5.3.</span> <span class="toc-text">进阶版</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#高级版"><span class="toc-number">5.4.</span> <span class="toc-text">高级版</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#终极版"><span class="toc-number">5.5.</span> <span class="toc-text">终极版</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#文件传输"><span class="toc-number">6.</span> <span class="toc-text">文件传输</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#简单文件传输"><span class="toc-number">6.1.</span> <span class="toc-text">简单文件传输</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#函数版"><span class="toc-number">6.2.</span> <span class="toc-text">函数版</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#UDP代码实例"><span class="toc-number">7.</span> <span class="toc-text">UDP代码实例</span></a></li></ol>
    </div>
    
    <hr>
<h1 id="Socket"><a href="#Socket" class="headerlink" title="Socket"></a>Socket</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Socket是应用层与TCP&#x2F;IP协议族通信的中间软件抽象层,它是一组接口.在设计模式中,Socket其实就是一个门面模式,它把复杂的TCP&#x2F;IP协议族隐藏在Socket接口后面,对用户来说,一组简单的接口就是全部.</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="Socket套接字方法"><a href="#Socket套接字方法" class="headerlink" title="Socket套接字方法"></a>Socket套接字方法</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">实例化: socket.socket(family&#x3D;AF_INET, type&#x3D;SOCK_STREAM, proto&#x3D;0, fileno&#x3D;None)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">family(socket家族)</span><br><span class="line"></span><br><span class="line">    socket.AF_UNIX：用于本机进程间通讯,为了保证程序安全,两个独立的程序(进程间是不能互相访问彼此的内存的,</span><br><span class="line">                    但为了实现进程间的通讯,可以通过创建一个本地的socket来完成</span><br><span class="line"></span><br><span class="line">    socket.AF_INET:(还有AF_INET6被用于ipv6,还有一些其他的地址家族,不过,他们要么是只用于某个平台,要么就是已经被废弃,或者是很少被使用,</span><br><span class="line">                   或者是根本没有实现,所有地址家族中,AF_INET是使用最广泛的一个,python支持很多种地址家族,但是由于我们只关心网络编程,</span><br><span class="line">                   所以大部分时候我么只使用AF_INET)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">socket type类型</span><br><span class="line"></span><br><span class="line">    socket.SOCK_STREAM  # for tcp</span><br><span class="line"></span><br><span class="line">    socket.SOCK_DGRAM   # for udp</span><br><span class="line"></span><br><span class="line">    socket.SOCK_RAW     # 原始套接字,普通的套接字无法处理ICMP、IGMP等网络报文,而SOCK_RAW可以;其次,SOCK_RAW也可以处理特殊的IPv4报文;</span><br><span class="line">                        # 此外,利用原始套接字,可以通过IP_HDRINCL套接字选项由用户构造IP头.</span><br><span class="line"></span><br><span class="line">    socket.SOCK_RDM     # 是一种可靠的UDP形式,即保证交付数据报但不保证顺序.SOCK_RAM用来提供对原始协议的低级访问,</span><br><span class="line">                        # 在需要执行某些特殊操作时使用,如发送ICMP报文.SOCK_RAM通常仅限于高级用户或管理员运行的程序使用.</span><br><span class="line"></span><br><span class="line">    socket.SOCK_SEQPACKET  # 废弃了</span><br><span class="line"></span><br><span class="line">(Only SOCK_STREAM and SOCK_DGRAM appear to be generally useful.)</span><br><span class="line">(通常只有SOCK_STREAM和SOCK_DGRAM有用)</span><br><span class="line"></span><br><span class="line">proto&#x3D;0 请忽略,特殊用途</span><br><span class="line"></span><br><span class="line">fileno&#x3D;None 请忽略,特殊用途</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"></span><br><span class="line">socket_obj = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">print(socket_obj)</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;socket.socket fd&#x3D;752, family&#x3D;AddressFamily.AF_INET, type&#x3D;SocketKind.SOCK_STREAM, proto&#x3D;0&gt;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="服务端套接字函数"><a href="#服务端套接字函数" class="headerlink" title="服务端套接字函数"></a>服务端套接字函数</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">socket_obj.bind((&#39;字符串形式的IP地址&#39;, 端口号))  # 绑定(主机,端口号)到套接字</span><br><span class="line"></span><br><span class="line">socket_obj.listen(n)  # 开始TCP监听,n指定系统在拒绝新连接之前允许的不可接受的连接数,如果未指定,则选择默认的合理值</span><br><span class="line"></span><br><span class="line">socket_obj.accept()  # 等待传入连接.返回代表连接的新套接字和客户端的地址.对于IP套接字,地址信息为一对(hostaddr,端口).</span><br><span class="line"></span><br><span class="line">sock_server.setsockopt(socket.SOL_SOCKET,socket.SO_REUSEADDR,1) # 解决ip端口占用问题,重用地址,写在bind之前</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="客户端套接字函数"><a href="#客户端套接字函数" class="headerlink" title="客户端套接字函数"></a>客户端套接字函数</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">socket_obj.connect() 主动初始化TCP服务器连接</span><br><span class="line"></span><br><span class="line">socket_obj.connect_ex() connect()函数的扩展版本,出错时返回出错码,而不是抛出异常</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="公共用途的套接字函数"><a href="#公共用途的套接字函数" class="headerlink" title="公共用途的套接字函数"></a>公共用途的套接字函数</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">socket_obj.recv()  # 接收数据</span><br><span class="line"></span><br><span class="line">socket_obj.send()  # 发送数据(send在待发送数据量大于己端缓存区剩余空间时,数据丢失,不会发完,可后面通过实例解释)</span><br><span class="line"></span><br><span class="line">socket_obj.sendall()  # 发送完整的TCP数据(本质就是循环调用send,sendall在待发送数据量大于己端缓存区剩余空间时,</span><br><span class="line">                      # 数据不丢失,循环调用send直到发完)</span><br><span class="line"></span><br><span class="line">socket_obj.sendto()  # 像socket_obj.send()一样,但是需要指定ip与端口,UDP使用.</span><br><span class="line"></span><br><span class="line">socket_obj.recvfrom()  # 从套接字接收数据.返回值是一对(字节,地址),UDP使用.</span><br><span class="line"></span><br><span class="line">socket_obj.getpeername()  # 连接到当前套接字的远端的地址</span><br><span class="line"></span><br><span class="line">socket_obj.close()  # 关闭套接字</span><br><span class="line"></span><br><span class="line">socket.setblocking(flag)  # True or False,设置socket为非阻塞模式,io异步时会用</span><br><span class="line"></span><br><span class="line">socket.getaddrinfo(host, port, family&#x3D;0, type&#x3D;0, proto&#x3D;0, flags&#x3D;0)  # 返回远程主机的地址信息,</span><br><span class="line">                                                                    # 例子 socket.getaddrinfo(&#39;luffycity.com&#39;,80)</span><br><span class="line"></span><br><span class="line">socket.getfqdn()  # 拿到本机的主机名</span><br><span class="line"></span><br><span class="line">socket.gethostbyname()  # 通过域名解析ip地址</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="TCP代码实例"><a href="#TCP代码实例" class="headerlink" title="TCP代码实例"></a>TCP代码实例</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">注意:TCP在使用send的时候是不能发送空字符的,发送空当把信息给系统的时候,系统认为什么都没有,程序就会卡住.</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 服务端S, server.py</span></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"></span><br><span class="line">server = socket.socket(socket.AF_INET, socket.SOCK_STREAM)  <span class="comment"># 生成基于ipv4的socket实例化对象</span></span><br><span class="line"></span><br><span class="line">server.bind((<span class="string">'127.0.0.1'</span>, <span class="number">9000</span>))  <span class="comment"># 绑定ip端口到套接字</span></span><br><span class="line"></span><br><span class="line">server.listen(<span class="number">5</span>)  <span class="comment"># 开启TCP监听</span></span><br><span class="line"></span><br><span class="line">conn, remote_add = server.accept()  <span class="comment"># 当客户端连接,返回成功连接的套接字与客户端的IP地址与端口</span></span><br><span class="line"></span><br><span class="line">data = conn.recv(<span class="number">1024</span>)  <span class="comment"># 接收客户端发送来的数据,1024表示接收数据的最大大小为1024字节</span></span><br><span class="line"></span><br><span class="line">print(data.decode(<span class="string">'utf-8'</span>))  <span class="comment"># 查看接收的数据</span></span><br><span class="line"></span><br><span class="line">conn.close()  <span class="comment"># 关闭连接套接字</span></span><br><span class="line"></span><br><span class="line">server.close()  <span class="comment"># 关闭服务端套接字</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 最后一步运行服务端</span></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 客户端C, client.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"></span><br><span class="line">client = socket.socket(socket.AF_INET, socket.SOCK_STREAM)  <span class="comment"># 生成基于ipv4的socket实例化对象</span></span><br><span class="line"></span><br><span class="line">client.connect((<span class="string">'127.0.0.1'</span>, <span class="number">9000</span>))  <span class="comment"># 指定ip与端口连接到服务端</span></span><br><span class="line"></span><br><span class="line">client.send(<span class="string">'hello'</span>.encode(<span class="string">'utf-8'</span>))  <span class="comment"># 需要以字节形式发送数据到服务端</span></span><br><span class="line"></span><br><span class="line">client.close()  <span class="comment"># 关闭客户端</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 最后一步运行客户端</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 服务端S, server.py</span><br><span class="line"></span><br><span class="line">hello</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="循环收发数据"><a href="#循环收发数据" class="headerlink" title="循环收发数据"></a>循环收发数据</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 服务端</span></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"></span><br><span class="line">server = socket.socket(socket.AF_INET, socket.SOCK_STREAM)  <span class="comment"># 生成基于ipv4的socket实例化对象</span></span><br><span class="line"></span><br><span class="line">server.bind((<span class="string">'127.0.0.1'</span>, <span class="number">9000</span>))  <span class="comment"># 绑定ip端口到套接字</span></span><br><span class="line"></span><br><span class="line">server.listen(<span class="number">5</span>)  <span class="comment"># 开启TCP监听</span></span><br><span class="line"></span><br><span class="line">conn, remote_add = server.accept()  <span class="comment"># 当客户端连接,返回成功连接的套接字与客户端的IP地址与端口</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    data = conn.recv(<span class="number">1024</span>)  <span class="comment"># 接收客户端发送来的数据,1024表示接收数据的最大大小为1024字节</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> msg:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    print(<span class="string">f'[remote]:'</span>, data.decode(<span class="string">'utf-8'</span>))  <span class="comment"># 查看接受的数据</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">conn.close()  <span class="comment"># 关闭连接套接字</span></span><br><span class="line">server.close()  <span class="comment"># 关闭服务端套接字</span></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 客户端</span></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"></span><br><span class="line">client = socket.socket(socket.AF_INET, socket.SOCK_STREAM)  <span class="comment"># 生成基于ipv4的socket实例化对象</span></span><br><span class="line"></span><br><span class="line">client.connect((<span class="string">'127.0.0.1'</span>, <span class="number">9000</span>))  <span class="comment"># 指定ip与端口连接到服务端</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    msg = input(<span class="string">'&gt;&gt;&gt;:'</span>).strip()</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> msg:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">if</span> msg == <span class="string">'exit'</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    client.send(msg.encode(<span class="string">'utf-8'</span>))  <span class="comment"># 需要以字节形式发送数据到服务端</span></span><br><span class="line"></span><br><span class="line">client.close()  <span class="comment"># 关闭客户端</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 客户端运行</span><br><span class="line">&gt;&gt;&gt;:aa</span><br><span class="line">&gt;&gt;&gt;:send</span><br><span class="line">&gt;&gt;&gt;:exit</span><br><span class="line"></span><br><span class="line"># 服务端</span><br><span class="line">[remote]: aa</span><br><span class="line">[remote]: send</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="一问一回聊天"><a href="#一问一回聊天" class="headerlink" title="一问一回聊天"></a>一问一回聊天</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 服务端</span></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"></span><br><span class="line">server = socket.socket(socket.AF_INET, socket.SOCK_STREAM)  <span class="comment"># 生成基于ipv4的socket实例化对象</span></span><br><span class="line"></span><br><span class="line">server.bind((<span class="string">'127.0.0.1'</span>, <span class="number">9000</span>))  <span class="comment"># 绑定ip端口到套接字</span></span><br><span class="line"></span><br><span class="line">server.listen(<span class="number">5</span>)  <span class="comment"># 开启TCP监听</span></span><br><span class="line"></span><br><span class="line">conn, remote_add = server.accept()  <span class="comment"># 当客户端连接,返回成功连接的套接字与客户端的IP地址与端口</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    data = conn.recv(<span class="number">1024</span>)  <span class="comment"># 接收客户端发送来的数据,1024表示接收数据的最大大小为1024字节</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> data:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    print(<span class="string">f'[client]:'</span>, data.decode(<span class="string">'utf-8'</span>))  <span class="comment"># 查看接受的数据</span></span><br><span class="line">    msg = input(<span class="string">'[server]&gt;&gt;&gt;:'</span>).strip()</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> msg:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">if</span> msg == <span class="string">'exit'</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    conn.send(msg.encode(<span class="string">'utf-8'</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">conn.close()  <span class="comment"># 关闭连接套接字</span></span><br><span class="line">server.close()  <span class="comment"># 关闭服务端套接字</span></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 客户端</span></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"></span><br><span class="line">client = socket.socket(socket.AF_INET, socket.SOCK_STREAM)  <span class="comment"># 生成基于ipv4的socket实例化对象</span></span><br><span class="line"></span><br><span class="line">client.connect((<span class="string">'127.0.0.1'</span>, <span class="number">9000</span>))  <span class="comment"># 指定ip与端口连接到服务端</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    msg = input(<span class="string">'[client]&gt;&gt;&gt;:'</span>).strip()</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> msg:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">if</span> msg == <span class="string">'exit'</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    client.send(msg.encode(<span class="string">'utf-8'</span>))  <span class="comment"># 需要以字节形式发送数据到服务端</span></span><br><span class="line">    data = client.recv(<span class="number">1024</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> data:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    print(<span class="string">f'[server]:'</span>, data.decode(<span class="string">'utf-8'</span>))</span><br><span class="line"></span><br><span class="line">client.close()  <span class="comment"># 关闭客户端</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># 客户端</span><br><span class="line">[client]&gt;&gt;&gt;:i client  # 1. 客户端发消息</span><br><span class="line">[server]: i server    # 4. 客户端收到消息</span><br><span class="line">[client]&gt;&gt;&gt;:hi server</span><br><span class="line">[server]: hi client</span><br><span class="line">[client]&gt;&gt;&gt;:Goodbye</span><br><span class="line">[server]: bye bye</span><br><span class="line">[client]&gt;&gt;&gt;:exit</span><br><span class="line"></span><br><span class="line"># 服务端</span><br><span class="line">[client]: i client    # 2. 服务端收到消息</span><br><span class="line">[server]&gt;&gt;&gt;:i server  # 3. 服务端发消息</span><br><span class="line">[client]: hi server</span><br><span class="line">[server]&gt;&gt;&gt;:hi client</span><br><span class="line">[client]: Goodbye</span><br><span class="line">[server]&gt;&gt;&gt;:bye bye</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="连接循环"><a href="#连接循环" class="headerlink" title="连接循环"></a>连接循环</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">连接循环是指在通信套接字关闭连接后,本地监听并不会关闭,会继续等待连接</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 服务端</span></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"></span><br><span class="line">server = socket.socket(socket.AF_INET, socket.SOCK_STREAM)  <span class="comment"># 生成基于ipv4的socket实例化对象</span></span><br><span class="line"></span><br><span class="line">server.bind((<span class="string">'127.0.0.1'</span>, <span class="number">9000</span>))  <span class="comment"># 绑定ip端口到套接字</span></span><br><span class="line"></span><br><span class="line">server.listen(<span class="number">5</span>)  <span class="comment"># 开启TCP监听</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    conn, remote_add = server.accept()  <span class="comment"># 当客户端连接,返回成功连接的套接字与客户端的IP地址与端口</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        data = conn.recv(<span class="number">1024</span>)  <span class="comment"># 接收客户端发送来的数据,1024表示接收数据的最大大小为1024字节</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> data:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        print(<span class="string">f'[client]:'</span>, data.decode(<span class="string">'utf-8'</span>))  <span class="comment"># 查看接受的数据</span></span><br><span class="line">        msg = input(<span class="string">'[server]&gt;&gt;&gt;:'</span>).strip()</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> msg:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">if</span> msg == <span class="string">'exit'</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        conn.send(msg.encode(<span class="string">'utf-8'</span>))</span><br><span class="line"></span><br><span class="line">    conn.close()  <span class="comment"># 关闭连接套接字</span></span><br><span class="line"></span><br><span class="line">server.close()  <span class="comment"># 关闭服务端套接字</span></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 客户端</span></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"></span><br><span class="line">client = socket.socket(socket.AF_INET, socket.SOCK_STREAM)  <span class="comment"># 生成基于ipv4的socket实例化对象</span></span><br><span class="line"></span><br><span class="line">client.connect((<span class="string">'127.0.0.1'</span>, <span class="number">9000</span>))  <span class="comment"># 指定ip与端口连接到服务端</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    msg = input(<span class="string">'[client]&gt;&gt;&gt;:'</span>).strip()</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> msg:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">if</span> msg == <span class="string">'exit'</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    client.send(msg.encode(<span class="string">'utf-8'</span>))  <span class="comment"># 需要以字节形式发送数据到服务端</span></span><br><span class="line">    data = client.recv(<span class="number">1024</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> data:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    print(<span class="string">f'[server]:'</span>, data.decode(<span class="string">'utf-8'</span>))</span><br><span class="line"></span><br><span class="line">client.close()  <span class="comment"># 关闭客户端</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="模拟ssh远程执行命令"><a href="#模拟ssh远程执行命令" class="headerlink" title="模拟ssh远程执行命令"></a>模拟ssh远程执行命令</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">远程执行命令重要的是在服务端上执行命令并获取结果,os.system能执行命令,但是不能获取到结果,</span><br><span class="line">需要使用subprocess.Poper</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 服务端</span></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"></span><br><span class="line">server = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">server.bind((<span class="string">'127.0.0.1'</span>, <span class="number">9000</span>))</span><br><span class="line">server.listen(<span class="number">5</span>)</span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line"></span><br><span class="line">    conn, addr = server.accept()</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            cmd = conn.recv(<span class="number">1024</span>)</span><br><span class="line">            result = subprocess.Popen(cmd.decode(<span class="string">'gbk'</span>), shell=<span class="literal">True</span>,  <span class="comment"># 执行命令将结果存在管道里</span></span><br><span class="line">                                      stdout=subprocess.PIPE,</span><br><span class="line">                                      stderr=subprocess.PIPE)</span><br><span class="line">            stdout = result.stdout.read()</span><br><span class="line">            stderr = result.stderr.read()</span><br><span class="line">            conn.send(stdout+stderr)</span><br><span class="line">        <span class="keyword">except</span> ConnectionResetError:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    conn.close()</span><br><span class="line"></span><br><span class="line">server.close()</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 客户端</span></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"></span><br><span class="line">client = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line"></span><br><span class="line">client.connect((<span class="string">'127.0.0.1'</span>, <span class="number">9000</span>))</span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    msg = input(<span class="string">'&gt;&gt;&gt;:'</span>).strip()</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> msg:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    client.send(msg.encode(<span class="string">'gbk'</span>))</span><br><span class="line">    <span class="keyword">if</span> msg == <span class="string">'exit'</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    result = client.recv(<span class="number">1024</span>)</span><br><span class="line">    print(result.decode(<span class="string">'gbk'</span>))</span><br><span class="line"></span><br><span class="line">client.close()</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># 客户端</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt;:ping localhost</span><br><span class="line"></span><br><span class="line">正在 Ping DESKTOP-GKAJSS2 [::1] 具有 32 字节的数据:</span><br><span class="line">来自 ::1 的回复: 时间&lt;1ms </span><br><span class="line">来自 ::1 的回复: 时间&lt;1ms </span><br><span class="line">来自 ::1 的回复: 时间&lt;1ms </span><br><span class="line">来自 ::1 的回复: 时间&lt;1ms </span><br><span class="line"></span><br><span class="line">::1 的 Ping 统计信息:</span><br><span class="line">    数据包: 已发送 &#x3D; 4,已接收 &#x3D; 4,丢失 &#x3D; 0 (0% 丢失),</span><br><span class="line">往返行程的估计时间(以毫秒为单位):</span><br><span class="line">    最短 &#x3D; 0ms,最长 &#x3D; 0ms,平均 &#x3D; 0ms</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="粘包"><a href="#粘包" class="headerlink" title="粘包"></a>粘包</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">模拟ssh远程执行命令成功了,但是会出现一个问题就是如果一次命令执行返回的字节数超出1024,客户端接收到的结果并不完整,</span><br><span class="line">在客户端输入下一个命令时返回的会包含上一个命令剩余的结果,也就是说客户端并不能准确的接收完服务端发送来的数据,</span><br><span class="line">这个现象叫做粘包,就是指两次结果粘到一起了,它的发生主要是因为socket缓冲区导致的.</span><br><span class="line"></span><br><span class="line">所谓粘包问题主要还是因为接收方不知道消息之间的界限,不知道一次性提取多少字节的数据所造成的.</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="客户端粘包"><a href="#客户端粘包" class="headerlink" title="客户端粘包"></a>客户端粘包</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 服务端</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line">server = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">server.bind((<span class="string">'127.0.0.1'</span>, <span class="number">9000</span>))</span><br><span class="line">server.listen(<span class="number">5</span>)</span><br><span class="line">conn, addr = server.accept()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">data = conn.recv(<span class="number">1024</span>)  <span class="comment"># 注意这里接收1024字节,由于客户端粘包发送,第一次接收到的是b'helloworld'</span></span><br><span class="line">print(data)</span><br><span class="line"></span><br><span class="line">data = conn.recv(<span class="number">5</span>)     <span class="comment"># 第二次接收消息什么都不会得到</span></span><br><span class="line">print(data)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">conn.close()</span><br><span class="line">server.close()</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 客户端</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line">client = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">client.connect((<span class="string">'127.0.0.1'</span>, <span class="number">9000</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">client.send(<span class="string">'hello'</span>.encode(<span class="string">'utf-8'</span>))  <span class="comment"># 因为TCP有Nagle优化算法,两次发送的数据小而且时间间隔短,所以两次的数据会被合并起来发送</span></span><br><span class="line">client.send(<span class="string">'world'</span>.encode(<span class="string">'utf-8'</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">client.close()</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 服务端</span><br><span class="line">b&#39;helloworld&#39;</span><br><span class="line">b&#39;&#39;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="服务端粘包"><a href="#服务端粘包" class="headerlink" title="服务端粘包"></a>服务端粘包</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 服务端</span></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">server = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line"></span><br><span class="line">server.bind((<span class="string">'127.0.0.1'</span>, <span class="number">9000</span>))</span><br><span class="line"></span><br><span class="line">server.listen(<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">conn, addr = server.accept()</span><br><span class="line"></span><br><span class="line">data = conn.recv(<span class="number">4</span>)  <span class="comment"># 第一次接收,注意这里只接受了4个字节,而'hello'是5个字节,这次只接收了b'hell'</span></span><br><span class="line">print(data)</span><br><span class="line">time.sleep(<span class="number">2</span>)  <span class="comment"># 增大时间间隔,使第一次接收对应客户端的第一次发送,第二次接收对应客户端的第一次发送</span></span><br><span class="line">data = conn.recv(<span class="number">1024</span>)  <span class="comment"># 第二次接收,由于第一次接收不完第一次发送的消息,第二次会得到b'oworld'</span></span><br><span class="line">print(data)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">conn.close()</span><br><span class="line"></span><br><span class="line">server.close()</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 客户端</span></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">client = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line"></span><br><span class="line">client.connect((<span class="string">'127.0.0.1'</span>, <span class="number">9000</span>))</span><br><span class="line"></span><br><span class="line">client.send(<span class="string">'hello'</span>.encode(<span class="string">'utf-8'</span>))</span><br><span class="line">time.sleep(<span class="number">1</span>)                          <span class="comment"># 这里增大时间间隔,客户端不再粘包</span></span><br><span class="line">client.send(<span class="string">'world'</span>.encode(<span class="string">'utf-8'</span>))</span><br><span class="line"></span><br><span class="line">client.close()</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 服务端</span><br><span class="line">b&#39;hell&#39;</span><br><span class="line">b&#39;oworld&#39;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">1. TCP(transport control protocol,传输控制协议)是面向连接的,面向流的,提供高可靠性服务.</span><br><span class="line">   收发两端(客户端和服务器端)都要有一一成对的socket,因此,发送端为了将多个发往接收端的包,</span><br><span class="line">   更有效的发到对方,使用了优化方法(Nagle算法),将多次间隔较小且数据量小的数据,合并成一个大的数据块,</span><br><span class="line">   然后进行封包.这样,接收端,就难于分辨出来了,必须提供科学的拆包机制.即面向流的通信是无消息保护边界的.</span><br><span class="line"></span><br><span class="line">2. UDP(user datagram protocol,用户数据报协议)是无连接的,面向消息的,提供高效率服务.不会使用块的合并优化算法,</span><br><span class="line">   由于UDP支持的是一对多的模式,所以接收端的skbuff(套接字缓冲区)采用了链式结构来记录每一个到达的UDP包,</span><br><span class="line">   在每个UDP包中就有了消息头(消息来源地址,端口等信息),这样,对于接收端来说,就容易进行区分处理了.即面向消息的通信是有消息保护边界的.</span><br><span class="line"></span><br><span class="line">3. tcp是基于数据流的,于是收发的消息不能为空,这就需要在客户端和服务端都添加空消息的处理机制,防止程序卡住,</span><br><span class="line">   而udp是基于数据报的,即便是你输入的是空内容(直接回车),那也不是空消息,udp协议会帮你封装上消息头.</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="粘包解决方案"><a href="#粘包解决方案" class="headerlink" title="粘包解决方案"></a>粘包解决方案</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">问题的根源在于,接收端不知道发送端将要传送的字节流的长度,所以解决粘包的方法就是围绕,如何让发送端在发送数据前,</span><br><span class="line">把自己将要发送的字节流总大小让接收端知晓,然后接收端来一个死循环接收完所有数据.</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="粗略版"><a href="#粗略版" class="headerlink" title="粗略版"></a>粗略版</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">客户端使用一个循环来接收数据,直到数据长度小于1024,退出循环.</span><br><span class="line"></span><br><span class="line">问题:如果返回的结果正好是1024的倍数,程序就会卡在result &#x3D; client.recv(1024)处</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 服务端</span></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line">server = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line"></span><br><span class="line">server.bind((<span class="string">'127.0.0.1'</span>, <span class="number">9000</span>))</span><br><span class="line"></span><br><span class="line">server.listen(<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    conn, addr = server.accept()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            cmd = conn.recv(<span class="number">1024</span>).decode(<span class="string">'utf-8'</span>)</span><br><span class="line">            print(cmd)</span><br><span class="line">            result = subprocess.Popen(cmd, shell=<span class="literal">True</span>,</span><br><span class="line">                                      stdout=subprocess.PIPE,</span><br><span class="line">                                      stderr=subprocess.PIPE)</span><br><span class="line">            stdout = result.stdout.read()</span><br><span class="line">            stderr = result.stderr.read()</span><br><span class="line">            conn.send(stdout)</span><br><span class="line">            conn.send(stderr)</span><br><span class="line">        <span class="keyword">except</span> ConnectionResetError:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    conn.close()</span><br><span class="line"></span><br><span class="line">server.close()</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 客户端</span></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"></span><br><span class="line">client = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line"></span><br><span class="line">client.connect((<span class="string">'127.0.0.1'</span>, <span class="number">9000</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    cmd = input(<span class="string">'&gt;&gt;&gt;:'</span>).strip()</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> cmd:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">if</span> cmd == <span class="string">'exit'</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    client.send(cmd.encode(<span class="string">'utf-8'</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line"></span><br><span class="line">        result = client.recv(<span class="number">1024</span>)</span><br><span class="line">        print(result.decode(<span class="string">'gbk'</span>))</span><br><span class="line">        <span class="keyword">if</span> len(result) &lt; <span class="number">1024</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">client.close()</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># 客户端</span><br><span class="line">&gt;&gt;&gt;:netsh interface ipv4 show ipaddress interface&#x3D;&quot;WLAN&quot;</span><br><span class="line"></span><br><span class="line">地址 192.168.200.10 参数</span><br><span class="line">---------------------------------------------------------</span><br><span class="line">接口 Luid          : WLAN</span><br><span class="line">作用域 ID          : 0.0</span><br><span class="line">有效生存时间       : infinite</span><br><span class="line">首选生存时间       : infinite</span><br><span class="line">DAD 状态           : 首选项</span><br><span class="line">地址类型           : 手动</span><br><span class="line">跳过作为源         : false</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="普通版"><a href="#普通版" class="headerlink" title="普通版"></a>普通版</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">服务端将产生的结果进行长度统计,将返回结果的长度先告诉客户端,客户端得到包长向服务端确认,服务端收到确认信息开始发送数据,</span><br><span class="line">客户端根据结果长度循环获取结果,结果是1024的倍数也不会卡住.</span><br><span class="line"></span><br><span class="line">问题:每次返回结果都要先告诉结果的长度,客户端还要向服务端确认,效率低.</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 服务端</span></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line">server = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line"></span><br><span class="line">server.bind((<span class="string">'127.0.0.1'</span>, <span class="number">9000</span>))</span><br><span class="line"></span><br><span class="line">server.listen(<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    conn, addr = server.accept()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            cmd = conn.recv(<span class="number">1024</span>).decode(<span class="string">'utf-8'</span>)</span><br><span class="line">            print(cmd)</span><br><span class="line">            result = subprocess.Popen(cmd, shell=<span class="literal">True</span>,</span><br><span class="line">                                      stdout=subprocess.PIPE,</span><br><span class="line">                                      stderr=subprocess.PIPE)</span><br><span class="line"></span><br><span class="line">            stdout = result.stdout.read()</span><br><span class="line">            <span class="comment"># 返回的结果不是正确就是错误的</span></span><br><span class="line">            <span class="keyword">if</span> stdout:</span><br><span class="line">                result_data = stdout</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                result_data = result.stderr.read()</span><br><span class="line">            <span class="comment"># 发送结果的大小</span></span><br><span class="line">            conn.send(<span class="string">f'<span class="subst">&#123;len(result_data)&#125;</span>'</span>.encode(<span class="string">'utf-8'</span>))</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 等待客户端确认已经获得包的大小</span></span><br><span class="line">            <span class="keyword">if</span> conn.recv(<span class="number">1024</span>).decode(<span class="string">'utf-8'</span>) == <span class="string">'ready'</span>:</span><br><span class="line"></span><br><span class="line">                <span class="comment"># 发送结果</span></span><br><span class="line">                conn.send(result_data)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">except</span> ConnectionResetError:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    conn.close()</span><br><span class="line"></span><br><span class="line">server.close()</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 客户端</span></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">client = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line"></span><br><span class="line">client.connect((<span class="string">'127.0.0.1'</span>, <span class="number">9000</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    cmd = input(<span class="string">'&gt;&gt;&gt;:'</span>).strip()</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> cmd:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">if</span> cmd == <span class="string">'exit'</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    client.send(cmd.encode(<span class="string">'utf-8'</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 先获取结果的大小</span></span><br><span class="line">    data = client.recv(<span class="number">1024</span>).decode(<span class="string">'utf-8'</span>)</span><br><span class="line">    pack_size = int(data)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 告诉服务端已经获得包的大小,可以将数据传过来了</span></span><br><span class="line">    client.send(<span class="string">'ready'</span>.encode(<span class="string">'utf-8'</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 获取结果</span></span><br><span class="line">    result = <span class="string">b''</span></span><br><span class="line">    recv_size = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> recv_size &lt; pack_size:</span><br><span class="line">        data = client.recv(<span class="number">1024</span>)</span><br><span class="line">        result += data</span><br><span class="line">        recv_size += len(data)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 输出结果</span></span><br><span class="line">    print(result.decode(<span class="string">'gbk'</span>))</span><br><span class="line"></span><br><span class="line">client.close()</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># 客户端</span><br><span class="line">&gt;&gt;&gt;:netsh interface ipv4 show ipaddress interface&#x3D;&quot;WLAN&quot;</span><br><span class="line"></span><br><span class="line">地址 192.168.200.10 参数</span><br><span class="line">---------------------------------------------------------</span><br><span class="line">接口 Luid          : WLAN</span><br><span class="line">作用域 ID          : 0.0</span><br><span class="line">有效生存时间       : infinite</span><br><span class="line">首选生存时间       : infinite</span><br><span class="line">DAD 状态           : 首选项</span><br><span class="line">地址类型           : 手动</span><br><span class="line">跳过作为源         : false</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="进阶版"><a href="#进阶版" class="headerlink" title="进阶版"></a>进阶版</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">设置一个固定长度的消息头,消息头包含着数据的长度信息,服务端只需要发一次包,包前10个字节是数据的长度描述,剩余是数据,</span><br><span class="line">客户端先获取消息头,再根据长度信息准确获取结果,相较于普通版服务端不需要发送两次,也不需要等待客户端确认,效率提升.</span><br><span class="line"></span><br><span class="line">问题:10个字节不一定能完全描述数据的大小,10个字节最大能表示9999999999,不能排除有比这个数值更大的数据.</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 服务端</span></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"></span><br><span class="line">server = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line"></span><br><span class="line">server.bind((<span class="string">'127.0.0.1'</span>, <span class="number">9000</span>))</span><br><span class="line"></span><br><span class="line">server.listen(<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    conn, addr = server.accept()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            cmd = conn.recv(<span class="number">1024</span>).decode(<span class="string">'utf-8'</span>)</span><br><span class="line">            result = subprocess.Popen(cmd, shell=<span class="literal">True</span>,</span><br><span class="line">                                      stdout=subprocess.PIPE,</span><br><span class="line">                                      stderr=subprocess.PIPE)</span><br><span class="line">            stdout = result.stdout.read()</span><br><span class="line">            <span class="keyword">if</span> stdout:</span><br><span class="line">                result_data = stdout</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                result_data = result.stderr.read()</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 将数据大小和数据放在一起发送,前10个字节是数据的大小</span></span><br><span class="line">            w = str(len(result_data)).zfill(<span class="number">10</span>).encode(<span class="string">'gbk'</span>)</span><br><span class="line">            conn.send(w)</span><br><span class="line">            conn.send(result_data)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">except</span> ConnectionResetError:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    conn.close()</span><br><span class="line"></span><br><span class="line">server.close()</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 客户端</span></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"></span><br><span class="line">client = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line"></span><br><span class="line">client.connect((<span class="string">'127.0.0.1'</span>, <span class="number">9000</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    cmd = input(<span class="string">'&gt;&gt;&gt;:'</span>).strip()</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> cmd:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">if</span> cmd == <span class="string">'exit'</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    client.send(cmd.encode(<span class="string">'utf-8'</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 先获取数据头的大小</span></span><br><span class="line">    pack_size = int(client.recv(<span class="number">10</span>).decode(<span class="string">'gbk'</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 获取结果</span></span><br><span class="line">    result = <span class="string">b''</span></span><br><span class="line">    recv_size = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> recv_size &lt; pack_size:</span><br><span class="line">        data = client.recv(<span class="number">1024</span>)</span><br><span class="line">        result += data</span><br><span class="line">        recv_size += len(data)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 输出结果</span></span><br><span class="line">    print(result.decode(<span class="string">'gbk'</span>))</span><br><span class="line"></span><br><span class="line">client.close()</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># 客户端</span><br><span class="line">&gt;&gt;&gt;:netsh interface ipv4 show ipaddress interface&#x3D;&quot;WLAN&quot;</span><br><span class="line"></span><br><span class="line">地址 192.168.200.10 参数</span><br><span class="line">---------------------------------------------------------</span><br><span class="line">接口 Luid          : WLAN</span><br><span class="line">作用域 ID          : 0.0</span><br><span class="line">有效生存时间       : infinite</span><br><span class="line">首选生存时间       : infinite</span><br><span class="line">DAD 状态           : 首选项</span><br><span class="line">地址类型           : 手动</span><br><span class="line">跳过作为源         : false</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="高级版"><a href="#高级版" class="headerlink" title="高级版"></a>高级版</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">借助第三方模块struct,生成固定长度的消息头.</span><br><span class="line"></span><br><span class="line">用法: struct.pack(&#39;i&#39;, len(result_data)) 将整形数值转为字节类型</span><br><span class="line">用法: struct.unpack(&#39;i&#39;, byte) 将字节转为整数</span><br><span class="line"></span><br><span class="line">问题: struct.pack(&#39;i&#39;, len(result_data))能将整数转为C语言中的int,相较于进阶版更能节省空间,进阶版是使用字符串描述长度大小,</span><br><span class="line">而高级版使用字节描述长度大小,但是C语言的int也是有范围的,超过了范围无法转换,当然可以将&#39;i&#39;变为&#39;l&#39;表示长整形,但是如果数值小又占用空间.</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 服务端</span></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"></span><br><span class="line">server = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line"></span><br><span class="line">server.bind((<span class="string">'127.0.0.1'</span>, <span class="number">9000</span>))</span><br><span class="line"></span><br><span class="line">server.listen(<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    conn, addr = server.accept()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            cmd = conn.recv(<span class="number">1024</span>).decode(<span class="string">'utf-8'</span>)</span><br><span class="line">            result = subprocess.Popen(cmd, shell=<span class="literal">True</span>,</span><br><span class="line">                                      stdout=subprocess.PIPE,</span><br><span class="line">                                      stderr=subprocess.PIPE)</span><br><span class="line">            stdout = result.stdout.read()</span><br><span class="line">            <span class="keyword">if</span> stdout:</span><br><span class="line">                result_data = stdout</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                result_data = result.stderr.read()</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 将数据大小和数据放在一起发送,前4个字节是数据的大小</span></span><br><span class="line">            pick_size = struct.pack(<span class="string">'i'</span>, len(result_data))</span><br><span class="line">            conn.send(pick_size+result_data)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">except</span> ConnectionResetError:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    conn.close()</span><br><span class="line"></span><br><span class="line">server.close()</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 客户端</span></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"></span><br><span class="line">client = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line"></span><br><span class="line">client.connect((<span class="string">'127.0.0.1'</span>, <span class="number">9000</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    cmd = input(<span class="string">'&gt;&gt;&gt;:'</span>).strip()</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> cmd:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">if</span> cmd == <span class="string">'exit'</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    client.send(cmd.encode(<span class="string">'utf-8'</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 先获取数据头的大小</span></span><br><span class="line">    data = client.recv(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 获取数据头大小数据</span></span><br><span class="line">    pack_size = struct.unpack(<span class="string">'i'</span>, data)[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 获取结果</span></span><br><span class="line">    result = <span class="string">b''</span></span><br><span class="line">    recv_size = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> recv_size &lt; pack_size:</span><br><span class="line">        data = client.recv(<span class="number">1024</span>)</span><br><span class="line">        result += data</span><br><span class="line">        recv_size += len(data)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 输出结果</span></span><br><span class="line">    print(result.decode(<span class="string">'gbk'</span>))</span><br><span class="line"></span><br><span class="line">client.close()</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># 客户端</span><br><span class="line">&gt;&gt;&gt;:netsh interface ipv4 show ipaddress interface&#x3D;&quot;WLAN&quot;</span><br><span class="line"></span><br><span class="line">地址 192.168.200.10 参数</span><br><span class="line">---------------------------------------------------------</span><br><span class="line">接口 Luid          : WLAN</span><br><span class="line">作用域 ID          : 0.0</span><br><span class="line">有效生存时间       : infinite</span><br><span class="line">首选生存时间       : infinite</span><br><span class="line">DAD 状态           : 首选项</span><br><span class="line">地址类型           : 手动</span><br><span class="line">跳过作为源         : false</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="终极版"><a href="#终极版" class="headerlink" title="终极版"></a>终极版</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">自定义一个包头,包头里包含需要的信息,服务端返回结果时先发送包头的大小,再发送包头,最后发送数据.</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 服务端</span></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line">server = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">ip = (<span class="string">'127.0.0.1'</span>, <span class="number">9000</span>)</span><br><span class="line">server.bind(ip)</span><br><span class="line"></span><br><span class="line">server.listen(<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    conn, addr = server.accept()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            cmd = conn.recv(<span class="number">1024</span>).decode(<span class="string">'utf-8'</span>)</span><br><span class="line">            result = subprocess.Popen(cmd, shell=<span class="literal">True</span>,</span><br><span class="line">                                      stdout=subprocess.PIPE,</span><br><span class="line">                                      stderr=subprocess.PIPE)</span><br><span class="line">            stdout = result.stdout.read()</span><br><span class="line">            <span class="keyword">if</span> stdout:</span><br><span class="line">                result_data = stdout</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                result_data = result.stderr.read()</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 设置一个消息头格式, 分别是 服务器ip:port, 时间, 运行的命令, 包的数据大小</span></span><br><span class="line">            pack_header = &#123;<span class="string">'server'</span>: <span class="string">f'<span class="subst">&#123;ip[<span class="number">0</span>]&#125;</span>:<span class="subst">&#123;ip[<span class="number">1</span>]&#125;</span>'</span>,  </span><br><span class="line">                           <span class="string">'date'</span>: time.time(),</span><br><span class="line">                           <span class="string">'cmd'</span>: cmd,</span><br><span class="line">                           <span class="string">'data_size'</span>: len(result_data),</span><br><span class="line">                           &#125;</span><br><span class="line">            pack_header_byte = json.dumps(pack_header).encode(<span class="string">'utf-8'</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 1. 获取包头的大小并发送,因为包头不会很大,所以4个字节足够描述</span></span><br><span class="line">            header_size = struct.pack(<span class="string">'i'</span>, len(pack_header_byte))</span><br><span class="line">            conn.send(header_size)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 2. 发送包头</span></span><br><span class="line">            conn.send(pack_header_byte)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 3. 发送包数据</span></span><br><span class="line">            conn.send(result_data)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">except</span> ConnectionResetError:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    conn.close()</span><br><span class="line"></span><br><span class="line">server.close()</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 客户端</span></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line">client = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line"></span><br><span class="line">client.connect((<span class="string">'127.0.0.1'</span>, <span class="number">9000</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    cmd = input(<span class="string">'&gt;&gt;&gt;:'</span>).strip()</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> cmd:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">if</span> cmd == <span class="string">'exit'</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    client.send(cmd.encode(<span class="string">'utf-8'</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 先获取包头的大小</span></span><br><span class="line">    pack_header_size = struct.unpack(<span class="string">'i'</span>, client.recv(<span class="number">4</span>))[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 获取包头</span></span><br><span class="line">    pack_header = json.loads(client.recv(pack_header_size).decode(<span class="string">'utf-8'</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 从包头获取包数据大小</span></span><br><span class="line">    pack_size = pack_header[<span class="string">'data_size'</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 获取包数据</span></span><br><span class="line">    result = <span class="string">b''</span></span><br><span class="line">    recv_size = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> recv_size &lt; pack_size:</span><br><span class="line">        data = client.recv(<span class="number">1024</span>)</span><br><span class="line">        result += data</span><br><span class="line">        recv_size += len(data)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 输出结果</span></span><br><span class="line">    print(result.decode(<span class="string">'gbk'</span>))</span><br><span class="line"></span><br><span class="line">client.close()</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># 客户端</span><br><span class="line">&gt;&gt;&gt;:netsh interface ipv4 show ipaddress interface&#x3D;&quot;WLAN&quot;</span><br><span class="line"></span><br><span class="line">地址 192.168.200.10 参数</span><br><span class="line">---------------------------------------------------------</span><br><span class="line">接口 Luid          : WLAN</span><br><span class="line">作用域 ID          : 0.0</span><br><span class="line">有效生存时间       : infinite</span><br><span class="line">首选生存时间       : infinite</span><br><span class="line">DAD 状态           : 首选项</span><br><span class="line">地址类型           : 手动</span><br><span class="line">跳过作为源         : false</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="文件传输"><a href="#文件传输" class="headerlink" title="文件传输"></a>文件传输</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">在终极版基础上稍作改动实现文件传输.</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="简单文件传输"><a href="#简单文件传输" class="headerlink" title="简单文件传输"></a>简单文件传输</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">客户端向服务端发送文件,未做任何的输入检查与异常捕获.</span><br><span class="line"></span><br><span class="line">使用:get file_name, file_name为服务端share_dir文件夹下存在的文件</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 服务端</span></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line">share_dir = <span class="string">'./'</span></span><br><span class="line">ip = (<span class="string">'127.0.0.1'</span>, <span class="number">9000</span>)</span><br><span class="line"></span><br><span class="line">server = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">server.setsockopt(socket.SOL_SOCKET,socket.SO_REUSEADDR, <span class="number">1</span>)</span><br><span class="line">server.bind(ip)</span><br><span class="line"></span><br><span class="line">server.listen(<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    conn, addr = server.accept()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            cmd = conn.recv(<span class="number">1024</span>).decode(<span class="string">'utf-8'</span>).strip()  <span class="comment"># get 1.txt</span></span><br><span class="line">            file_name = cmd.split()[<span class="number">1</span>]  <span class="comment"># 1.txt</span></span><br><span class="line">            file_path = os.path.join(share_dir, file_name)</span><br><span class="line">            file_size = os.path.getsize(file_name)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 设置一个消息头格式, 分别是 服务器ip:port, 时间, 下载文件名, 文件大小, 文件是否存在</span></span><br><span class="line">            pack_header = &#123;<span class="string">'server'</span>: <span class="string">f'<span class="subst">&#123;ip[<span class="number">0</span>]&#125;</span>:<span class="subst">&#123;ip[<span class="number">1</span>]&#125;</span>'</span>,</span><br><span class="line">                           <span class="string">'date'</span>: time.time(),</span><br><span class="line">                           <span class="string">'file_name'</span>: file_name,</span><br><span class="line">                           <span class="string">'file_size'</span>: file_size</span><br><span class="line">                           &#125;</span><br><span class="line">            pack_header_byte = json.dumps(pack_header).encode(<span class="string">'utf-8'</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 1. 获取包头的大小并发送,因为包头不会很大,所以4个字节足够描述</span></span><br><span class="line">            header_size = struct.pack(<span class="string">'i'</span>, len(pack_header_byte))</span><br><span class="line">            conn.send(header_size)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 2. 发送包头</span></span><br><span class="line">            conn.send(pack_header_byte)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 3. 发送文件数据</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">with</span> open(file_path, <span class="string">'rb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">                <span class="keyword">for</span> line <span class="keyword">in</span> f:</span><br><span class="line">                    conn.send(line)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">except</span> ConnectionResetError:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    conn.close()</span><br><span class="line"></span><br><span class="line">server.close()</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 客户端</span></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">download_dir = <span class="string">'./'</span></span><br><span class="line">ip = (<span class="string">'127.0.0.1'</span>, <span class="number">9000</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">client = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line"></span><br><span class="line">client.connect(ip)</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    cmd = input(<span class="string">'&gt;&gt;&gt;:'</span>).strip()</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> cmd:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">if</span> cmd == <span class="string">'exit'</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    client.send(cmd.encode(<span class="string">'utf-8'</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 先获取包头的大小</span></span><br><span class="line">    pack_header_size = struct.unpack(<span class="string">'i'</span>, client.recv(<span class="number">4</span>))[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 获取包头</span></span><br><span class="line">    pack_header = json.loads(client.recv(pack_header_size).decode(<span class="string">'utf-8'</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 从包头获取文件数据大小</span></span><br><span class="line">    file_name = pack_header[<span class="string">'file_name'</span>]</span><br><span class="line">    file_size = pack_header[<span class="string">'file_size'</span>]</span><br><span class="line">    file_path = os.path.join(download_dir, file_name)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 获取包数据</span></span><br><span class="line">    <span class="keyword">with</span> open(file_path, <span class="string">'wb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">        recv_size = <span class="number">0</span></span><br><span class="line">        start_time = time.time()</span><br><span class="line">        <span class="keyword">while</span> recv_size &lt; file_size:</span><br><span class="line">            data = client.recv(<span class="number">1024</span>)</span><br><span class="line">            f.write(data)</span><br><span class="line">            recv_size += len(data)</span><br><span class="line">            <span class="keyword">if</span> time.time() - start_time &gt;= <span class="number">0.1</span>:</span><br><span class="line">                print(<span class="string">f'download: <span class="subst">&#123;int(recv_size / file_size * <span class="number">100</span>)&#125;</span>%'</span>)</span><br><span class="line">                start_time = time.time()</span><br><span class="line">        print(<span class="string">'download: 100%'</span>)</span><br><span class="line"></span><br><span class="line">client.close()</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># 客户端</span><br><span class="line">&gt;&gt;&gt;:get test.zip</span><br><span class="line">download: 8%</span><br><span class="line">download: 15%</span><br><span class="line">download: 24%</span><br><span class="line">download: 34%</span><br><span class="line">download: 46%</span><br><span class="line">download: 61%</span><br><span class="line">download: 75%</span><br><span class="line">download: 89%</span><br><span class="line">download: 100%</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="函数版"><a href="#函数版" class="headerlink" title="函数版"></a>函数版</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">增加客户端上传功能</span><br><span class="line"></span><br><span class="line">使用:</span><br><span class="line">    get file_name</span><br><span class="line">    put file_name</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 服务端</span></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line">share_dir = <span class="string">'./'</span></span><br><span class="line">ip = (<span class="string">'127.0.0.1'</span>, <span class="number">9000</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 服务端的put对应处理客户端的get</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">put</span><span class="params">(conn, file_name)</span>:</span> </span><br><span class="line"></span><br><span class="line">    file_path = os.path.join(share_dir, file_name)</span><br><span class="line">    file_size = os.path.getsize(file_name)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 设置一个消息头格式, 分别是 服务器ip:port, 时间, 下载文件名, 文件大小, 文件是否存在</span></span><br><span class="line">    pack_header = &#123;<span class="string">'server'</span>: <span class="string">f'<span class="subst">&#123;ip[<span class="number">0</span>]&#125;</span>:<span class="subst">&#123;ip[<span class="number">1</span>]&#125;</span>'</span>,</span><br><span class="line">                   <span class="string">'date'</span>: time.time(),</span><br><span class="line">                   <span class="string">'file_name'</span>: file_name,</span><br><span class="line">                   <span class="string">'file_size'</span>: file_size</span><br><span class="line">                   &#125;</span><br><span class="line">    pack_header_byte = json.dumps(pack_header).encode(<span class="string">'utf-8'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 1. 获取包头的大小并发送,因为包头不会很大,所以4个字节足够描述</span></span><br><span class="line">    header_size = struct.pack(<span class="string">'i'</span>, len(pack_header_byte))</span><br><span class="line">    conn.send(header_size)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 2. 发送包头</span></span><br><span class="line">    conn.send(pack_header_byte)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 3. 发送文件数据</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> open(file_path, <span class="string">'rb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">for</span> line <span class="keyword">in</span> f:</span><br><span class="line">            conn.send(line)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 服务端的get对应处理客户端的put</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(client)</span>:</span></span><br><span class="line">    <span class="comment"># 先获取包头的大小</span></span><br><span class="line">    pack_header_size = struct.unpack(<span class="string">'i'</span>, client.recv(<span class="number">4</span>))[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 获取包头</span></span><br><span class="line">    pack_header = json.loads(client.recv(pack_header_size).decode(<span class="string">'utf-8'</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 从包头获取文件数据大小</span></span><br><span class="line">    file_name = pack_header[<span class="string">'file_name'</span>]</span><br><span class="line">    file_size = pack_header[<span class="string">'file_size'</span>]</span><br><span class="line">    file_path = os.path.join(share_dir, file_name)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 获取包数据</span></span><br><span class="line">    <span class="keyword">with</span> open(file_path, <span class="string">'wb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">        recv_size = <span class="number">0</span></span><br><span class="line">        <span class="keyword">while</span> recv_size &lt; file_size:</span><br><span class="line">            data = client.recv(<span class="number">1024</span>)</span><br><span class="line">            f.write(data)</span><br><span class="line">            recv_size += len(data)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">()</span>:</span></span><br><span class="line">    server = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">    server.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, <span class="number">1</span>)</span><br><span class="line">    server.bind(ip)</span><br><span class="line"></span><br><span class="line">    server.listen(<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        conn, addr = server.accept()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                user_input = conn.recv(<span class="number">1024</span>).decode(<span class="string">'utf-8'</span>).strip()  <span class="comment"># get 1.txt</span></span><br><span class="line">                cmd = user_input.split()[<span class="number">0</span>]</span><br><span class="line">                file_name = user_input.split()[<span class="number">1</span>]</span><br><span class="line">                <span class="keyword">if</span> cmd == <span class="string">'get'</span>:</span><br><span class="line">                    put(conn, file_name)</span><br><span class="line">                <span class="keyword">if</span> cmd == <span class="string">'put'</span>:</span><br><span class="line">                    get(conn)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">except</span> ConnectionResetError:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">        conn.close()</span><br><span class="line"></span><br><span class="line">    server.close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    run()</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 客户端</span></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">download_dir = <span class="string">'./'</span></span><br><span class="line">ip = (<span class="string">'127.0.0.1'</span>, <span class="number">9000</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(client, cmd)</span>:</span></span><br><span class="line"></span><br><span class="line">    client.send(cmd.encode(<span class="string">'utf-8'</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 先获取包头的大小</span></span><br><span class="line">    pack_header_size = struct.unpack(<span class="string">'i'</span>, client.recv(<span class="number">4</span>))[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 获取包头</span></span><br><span class="line">    pack_header = json.loads(client.recv(pack_header_size).decode(<span class="string">'utf-8'</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 从包头获取文件数据大小</span></span><br><span class="line">    file_name = pack_header[<span class="string">'file_name'</span>]</span><br><span class="line">    file_size = pack_header[<span class="string">'file_size'</span>]</span><br><span class="line">    file_path = os.path.join(download_dir, file_name)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 获取包数据</span></span><br><span class="line">    <span class="keyword">with</span> open(file_path, <span class="string">'wb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">        recv_size = <span class="number">0</span></span><br><span class="line">        start_time = time.time()</span><br><span class="line">        <span class="keyword">while</span> recv_size &lt; file_size:</span><br><span class="line">            data = client.recv(<span class="number">1024</span>)</span><br><span class="line">            f.write(data)</span><br><span class="line">            recv_size += len(data)</span><br><span class="line">            <span class="keyword">if</span> time.time() - start_time &gt;= <span class="number">0.1</span>:</span><br><span class="line">                print(<span class="string">f'download: <span class="subst">&#123;int(recv_size / file_size * <span class="number">100</span>)&#125;</span>%'</span>)</span><br><span class="line">                start_time = time.time()</span><br><span class="line">        print(<span class="string">'download: 100%'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">put</span><span class="params">(conn, cmd)</span>:</span></span><br><span class="line">    conn.send(cmd.encode(<span class="string">'utf-8'</span>))</span><br><span class="line">    file_name = cmd.split()[<span class="number">1</span>]</span><br><span class="line">    file_path = os.path.join(download_dir, file_name)</span><br><span class="line">    file_size = os.path.getsize(file_name)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 设置一个消息头格式, 分别是 服务器ip:port, 时间, 下载文件名, 文件大小, 文件是否存在</span></span><br><span class="line">    pack_header = &#123;<span class="string">'server'</span>: <span class="string">f'<span class="subst">&#123;ip[<span class="number">0</span>]&#125;</span>:<span class="subst">&#123;ip[<span class="number">1</span>]&#125;</span>'</span>,</span><br><span class="line">                   <span class="string">'date'</span>: time.time(),</span><br><span class="line">                   <span class="string">'file_name'</span>: file_name,</span><br><span class="line">                   <span class="string">'file_size'</span>: file_size</span><br><span class="line">                   &#125;</span><br><span class="line">    pack_header_byte = json.dumps(pack_header).encode(<span class="string">'utf-8'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 1. 获取包头的大小并发送,因为包头不会很大,所以4个字节足够描述</span></span><br><span class="line">    header_size = struct.pack(<span class="string">'i'</span>, len(pack_header_byte))</span><br><span class="line">    conn.send(header_size)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 2. 发送包头</span></span><br><span class="line">    conn.send(pack_header_byte)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 3. 发送文件数据</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> open(file_path, <span class="string">'rb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">        count = <span class="number">0</span></span><br><span class="line">        start_time = time.time()</span><br><span class="line">        <span class="keyword">for</span> line <span class="keyword">in</span> f:</span><br><span class="line">            conn.send(line)</span><br><span class="line">            count += len(line)</span><br><span class="line">            <span class="keyword">if</span> time.time() - start_time &gt;= <span class="number">0.1</span>:</span><br><span class="line">                print(<span class="string">f'put: <span class="subst">&#123;int(count / file_size * <span class="number">100</span>)&#125;</span>%'</span>)</span><br><span class="line">                start_time = time.time()</span><br><span class="line">        print(<span class="string">'put: 100%'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">()</span>:</span></span><br><span class="line">    client = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">    client.connect(ip)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        cmd = input(<span class="string">'&gt;&gt;&gt;:'</span>).strip()</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> cmd:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">if</span> cmd == <span class="string">'exit'</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">if</span> cmd.startswith(<span class="string">'get '</span>):</span><br><span class="line">            get(client, cmd)</span><br><span class="line">        <span class="keyword">if</span> cmd.startswith(<span class="string">'put '</span>):</span><br><span class="line">            put(client, cmd)</span><br><span class="line"></span><br><span class="line">    client.close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    run()</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># 客户端</span><br><span class="line">&gt;&gt;&gt;:get 1.txt</span><br><span class="line">download: 100%</span><br><span class="line">&gt;&gt;&gt;:put test.zip</span><br><span class="line">put: 11%</span><br><span class="line">put: 24%</span><br><span class="line">put: 37%</span><br><span class="line">put: 50%</span><br><span class="line">put: 61%</span><br><span class="line">put: 74%</span><br><span class="line">put: 88%</span><br><span class="line">put: 100%</span><br><span class="line">&gt;&gt;&gt;:</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="UDP代码实例"><a href="#UDP代码实例" class="headerlink" title="UDP代码实例"></a>UDP代码实例</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">udp 不需要经过3次握手和4次挥手,不需要提前建立连接,直接发数据就行.</span><br><span class="line"></span><br><span class="line">udp 不经常使用,仅需了解.</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 服务端</span></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"></span><br><span class="line">server = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)</span><br><span class="line"></span><br><span class="line">server.bind((<span class="string">'127.0.0.1'</span>, <span class="number">9000</span>))</span><br><span class="line"></span><br><span class="line">msg, addr = server.recvfrom(<span class="number">1024</span>)</span><br><span class="line">print(msg.decode(<span class="string">'utf-8'</span>), addr)</span><br><span class="line"></span><br><span class="line">server.sendto(msg.upper(), addr)</span><br><span class="line"></span><br><span class="line">server.close()</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 客户端</span></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"></span><br><span class="line">client = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)</span><br><span class="line"></span><br><span class="line">msg = <span class="string">'aaaaa'</span>.encode(<span class="string">'utf-8'</span>)</span><br><span class="line">client.sendto(msg.decode(<span class="string">'utf-8'</span>), (<span class="string">'127.0.0.1'</span>, <span class="number">9000</span>))</span><br><span class="line">msg, addr = client.recvfrom(<span class="number">1024</span>)</span><br><span class="line">print(msg, addr)</span><br><span class="line"></span><br><span class="line">client.close()</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 客户端</span><br><span class="line">AAAAA (&#39;127.0.0.1&#39;, 9000)</span><br><span class="line"></span><br><span class="line"># 服务端</span><br><span class="line">aaaaa (&#39;127.0.0.1&#39;, 60671)</span><br></pre></td></tr></table></figure>

  </div>

</article>


  <nav id="pagenavi">
    
    
    <a href="/2020/07/29/2020-07-29-python第六章_网络编程/" class="next">下一篇：python第六章_网络编程</a>
    
  </nav>

<a href="#TOC">Top</a>
        </div>
         
        
      </div>
      <footer id="footer" class="inner">
        © 2020 - sgupergitquery -
        <span id="busuanzi_container_site_pv">PV <span id="busuanzi_value_site_pv"></span></span>
        <p>Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> & <a href="https://github.com/thinkerchan/hexo-theme-greyshade" target="_blank" rel="noopener">GreyShade</a></p>
      </footer>
    </div>
  </div>
  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  <script async src="https://s5.cnzz.com/z_stat.php?id=1276809529&web_id=1276809529"></script>
</body>
</html>